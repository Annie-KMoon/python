<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>{{title}}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <!-- ✅ 카카오맵 JS SDK -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=72b8186e3025db91d9a570623050d352"></script>
    <!-- ✅ 스크립트 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


  <style>
    #map {
      width: 100%;
      height: 400px;
    }
  </style>
</head>

<body class="p-4">

  <div class="container my-5">
    <h1 class="text-center">{{title}}</h1>

    <table class="table table-striped table-hover text-center" id="petvetTable">
      <thead>
        <tr>
          <th>관리번호</th>
          <th>사업장명</th>
          <th>도로명주소</th>
          <th>상세영업상태명</th>
          <!-- <th>좌표정보(X)</th>
          <th>좌표정보(Y)</th> -->
        </tr>
      </thead>
      <tbody>
        {% for i in info %}
        <tr class="hospital-row" data-name="{{ i['사업장명'] }}" data-x="{{ i['좌표정보(X)'] }}" data-y="{{ i['좌표정보(Y)'] }}">
          <td>{{ i['관리번호'] }}</td>
          <td>{{ i['사업장명'] }}</td>
          <td>{{ i['도로명주소'] }}</td>
          <td>{{ i['상세영업상태명'] }}</td>
          <!-- <td>{{ i['좌표정보(X)'] }}</td>
          <td>{{ i['좌표정보(Y)'] }}</td> -->
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- 페이지네이션 -->
    <div class="text-center my-4">
      {% if page > 1 %}
      <a href="?page={{ page - 1 }}" class="btn btn-secondary btn-sm">이전</a>
      {% else %}
      <button class="btn btn-secondary btn-sm" disabled>이전</button>
      {% endif %}

      <span class="mx-2">{{ page }} / {{ total_pages }}</span>

      {% if page < total_pages %} <a href="?page={{ page + 1 }}" class="btn btn-secondary btn-sm">다음</a>
        {% else %}
        <button class="btn btn-secondary btn-sm" disabled>다음</button>
        {% endif %}
    </div>
  </div>

  <!-- ✅ 지도 모달 -->
  <div class="modal fade" id="mapModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="hospitalName">지도 보기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let map, marker;

    window.onload = function () {  // ✅ SDK 로드 후에 이벤트 등록
      document.querySelectorAll('.hospital-row').forEach(row => {
        row.addEventListener('click', function () {
          const name = this.dataset.name;
          const x = parseFloat(this.dataset.x);
          const y = parseFloat(this.dataset.y);

          const lat = y;
          const lon = x;

          const modal = new bootstrap.Modal(document.getElementById('mapModal'));
          document.getElementById('hospitalName').textContent = name;
          modal.show();

          setTimeout(() => {
            if (typeof kakao === 'undefined' || !kakao.maps) {
              alert("카카오 지도 SDK가 아직 로드되지 않았습니다.");
              return;
            }

            const container = document.getElementById('map');
            const options = {
              center: new kakao.maps.LatLng(33.450701, 126.570667),
              // center: new kakao.maps.LatLng(lat, lon), #지도 로딩 오류
              level: 3
            };

            if (!map) {
              map = new kakao.maps.Map(container, options);
              marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(lat, lon),
                map: map
              });
            } else {
              map.setCenter(new kakao.maps.LatLng(lat, lon));
              marker.setPosition(new kakao.maps.LatLng(lat, lon));
            }
          }, 300);
        });
      });
    };
  </script>

</body>

</html>